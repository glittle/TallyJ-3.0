@inherits RazorEngine.Templating.TemplateBase
@using Newtonsoft.Json
@using TallyJ.Code
@using TallyJ.Code.Enumerations
@using TallyJ.Code.Session
@using TallyJ.CoreModels
@using TallyJ.EF
@{
  var ballots = new BallotCacher().AllForThisElection;
  var locations = new LocationCacher().AllForThisElection;
  var election = UserSession.CurrentElection;

  var data = ballots
    .OrderBy(b => b.ComputerCode)
    .ThenBy(b => b.BallotNumAtComputer)
    .Select(b =>
    {
      var location = locations.FirstOrDefault(l => l.LocationGuid == b.LocationGuid);
      var locName = locations.Count > 1 && location != null ? location.Name : "";
      var locId = location != null ? location.C_RowId : 0; // can't use ?.
  return new
      {
        b.C_BallotCode,
        Location = locName,
        LocationId = locId,
        BallotId = b.C_RowId,
        b.StatusCode,
        Spoiled = b.StatusCode != BallotStatusEnum.Ok,
        b.Teller1,
        b.Teller2,
      };
    });
}
<style>
  table.Ballots td {
    border: 1px solid #ccc;
    vertical-align: top;
    padding: 1px 3px 2px 5px;
  }

  table.Ballots {
    width: 100%;
    border-collapse: collapse;
    border-left-style: hidden;
    border-right-style: hidden;
    border-bottom-style: hidden;
  }

    table.Ballots td:first-child {
      white-space: nowrap;
    }

  .Count {
    font-weight: bold;
    padding: 0 5px;
    float: right;
  }

  .Ballot {
    margin-top: 3px;
  }

  .Spoiled {
    color: red;
  }
</style>
<div class="body">
  <div class="reportHead">
    <h1 id="title"></h1>
    <div class="byTitle">
      <div>@UserSession.CurrentElectionName</div>
      <div id="titleDate"></div>
    </div>
  </div>
  <button class="btn btn-mini btnDownloadCsv" data-table=".Ballots" type="button" title="Download in CSV format for Excel">Export</button>

  <p class="Comment">
    This lists the ballots and the tellers who entered them into TallyJ.
  </p>
  <table class="Ballots sortable">
    <thead>
      <tr>
        <th>Ballot</th>
        <th>Location</th>
        <th>Status</th>
        <th>Teller at Keyboard</th>
        <th>Teller Assisting</th>
      </tr>
    </thead>
    <tbody>
      @foreach (var ballot in data)
      {
        <tr class="Ballot">
          <td>
            <a href="../Ballots?l=@ballot.LocationId&b=@ballot.BallotId" target="ballot">@ballot.C_BallotCode</a>
          </td>
          <td>
            @ballot.Location
          </td>
          <td class="@(ballot.Spoiled ? "Spoiled" : "")">
            @ballot.StatusCode
          </td>
          <td>
            @ballot.Teller1
          </td>
          <td>
            @ballot.Teller2
          </td>
        </tr>
      }
    </tbody>
  </table>
</div>